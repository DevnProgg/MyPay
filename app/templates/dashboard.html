{% extends "base.html" %}

{% block title %}Dashboard — PayGateway Admin{% endblock %}
{% block topbar_title %}Overview{% endblock %}

{% block topbar_actions %}
  <form method="POST" action="{{ url_for('admin_dashboard.reconcile') }}" style="margin:0;">
    <button type="submit" class="btn-secondary btn-sm">
      <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      Reconcile
    </button>
  </form>
{% endblock %}

{% block content %}

{% set tx = stats.get('transactions', {}) %}
{% set period = stats.get('period', {}) %}

<!-- Period notice -->
<p class="text-muted mono mb-2" style="font-size:11px;">
  Period: {{ period.get('start_date', '—')[:10] }} → {{ period.get('end_date', '—')[:10] }}
</p>

<!-- Stat cards -->
<div class="stat-grid">
  <div class="stat-card">
    <div class="stat-label">Total Transactions</div>
    <div class="stat-value gradient-text">{{ tx.get('total', 0) | int }}</div>
    <div class="stat-sub">All statuses</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Completed</div>
    <div class="stat-value" style="color:var(--blue);">{{ tx.get('completed', 0) | int }}</div>
    <div class="stat-sub">Success rate: {{ "%.1f"|format(tx.get('success_rate', 0)) }}%</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Failed</div>
    <div class="stat-value" style="color:var(--coral);">{{ tx.get('failed', 0) | int }}</div>
    <div class="stat-sub">Requires attention</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Pending</div>
    <div class="stat-value" style="color:#FFC107;">{{ tx.get('pending', 0) | int }}</div>
    <div class="stat-sub">Awaiting provider</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Volume</div>
    <div class="stat-value gradient-text">{{ "%.2f"|format(tx.get('total_volume', 0)) }}</div>
    <div class="stat-sub">Completed transactions</div>
  </div>
</div>

<!-- Two column layout -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">

  <!-- By Provider -->
  <div class="card">
    <div class="section-title">Volume by Provider</div>
    {% set by_provider = stats.get('by_provider', []) %}
    {% if by_provider %}
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Provider</th>
              <th>Transactions</th>
              <th>Volume</th>
            </tr>
          </thead>
          <tbody>
            {% for row in by_provider %}
            <tr>
              <td><span class="badge badge-neutral">{{ row.provider | upper }}</span></td>
              <td class="mono">{{ row.count }}</td>
              <td class="mono">{{ "%.2f"|format(row.volume) }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted" style="font-size:13px;">No provider data for this period.</p>
    {% endif %}
  </div>

  <!-- System Health Summary -->
  <div class="card">
    <div class="section-title">System Health</div>
    <div style="display:flex;flex-direction:column;gap:12px;">
      {% set checks = health.get('checks', {}) %}
      {% for name, check in checks.items() %}
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(255,255,255,.02);border-radius:10px;border:1px solid var(--border);">
        <span style="font-size:13px;font-weight:500;text-transform:capitalize;">{{ name }}</span>
        <span class="badge {% if check.status == 'healthy' %}badge-success{% else %}badge-danger{% endif %}">
          <span class="health-dot {% if check.status == 'healthy' %}healthy{% else %}unhealthy{% endif %}"></span>
          {{ check.status }}
        </span>
      </div>
      {% endfor %}
      {% if not checks %}
        <p class="text-muted" style="font-size:13px;">No health data available.</p>
      {% endif %}
    </div>
    <a href="{{ url_for('admin_dashboard.system_health') }}" class="btn-secondary btn-sm mt-2">Full report →</a>
  </div>

</div>

<!-- Webhooks & Audit summary -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">

  <!-- Webhook stats -->
  <div class="card">
    <div class="flex items-center justify-between mb-2">
      <div class="section-title" style="margin-bottom:0;">Webhooks</div>
      <a href="{{ url_for('admin_dashboard.webhooks') }}" class="btn-secondary btn-sm">View all</a>
    </div>
    {% set wh = stats.get('webhooks', {}) %}
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:16px;">
      <div style="text-align:center;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:22px;">{{ wh.get('total', '—') }}</div>
        <div class="text-muted" style="font-size:11px;margin-top:2px;">Total</div>
      </div>
      <div style="text-align:center;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:22px;color:var(--blue);">{{ wh.get('processed', '—') }}</div>
        <div class="text-muted" style="font-size:11px;margin-top:2px;">Processed</div>
      </div>
      <div style="text-align:center;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:22px;color:var(--coral);">{{ wh.get('failed', '—') }}</div>
        <div class="text-muted" style="font-size:11px;margin-top:2px;">Failed</div>
      </div>
    </div>
  </div>

  <!-- Audit stats -->
  <div class="card">
    <div class="flex items-center justify-between mb-2">
      <div class="section-title" style="margin-bottom:0;">Audit Events</div>
      <a href="{{ url_for('admin_dashboard.audit_logs') }}" class="btn-secondary btn-sm">View all</a>
    </div>
    {% set ae = stats.get('audit_events', {}) %}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px;">
      <div style="text-align:center;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:22px;">{{ ae.get('total', '—') }}</div>
        <div class="text-muted" style="font-size:11px;margin-top:2px;">Total events</div>
      </div>
      <div style="text-align:center;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:22px;color:var(--blue);">{{ ae.get('event_types', '—') }}</div>
        <div class="text-muted" style="font-size:11px;margin-top:2px;">Event types</div>
      </div>
    </div>
  </div>

</div>

{% endblock %}