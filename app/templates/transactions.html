{% extends "base.html" %}

{% block title %}Transactions — PayGateway Admin{% endblock %}
{% block topbar_title %}Transactions{% endblock %}

{% block topbar_actions %}
  <form method="POST" action="{{ url_for('admin_dashboard.reconcile') }}" style="margin:0;">
    <button type="submit" class="btn-primary btn-sm">
      <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      Reconcile Pending
    </button>
  </form>
{% endblock %}

{% block content %}
{% set items = result.get('items', []) %}
{% set pagination = result.get('pagination', {}) %}

<!-- Filters -->
<form method="GET" action="{{ url_for('admin_dashboard.transactions') }}">
  <div class="filter-bar">
    <label>
      Provider
      <select name="provider" class="input-field">
        <option value="">All providers</option>
        <option value="mpesa"  {% if filters.provider == 'mpesa'  %}selected{% endif %}>M-Pesa</option>
        <option value="cpay"   {% if filters.provider == 'cpay'   %}selected{% endif %}>CPay</option>
      </select>
    </label>
    <label>
      Status
      <select name="status" class="input-field">
        <option value="">All statuses</option>
        <option value="pending"    {% if filters.status == 'pending'    %}selected{% endif %}>Pending</option>
        <option value="processing" {% if filters.status == 'processing' %}selected{% endif %}>Processing</option>
        <option value="completed"  {% if filters.status == 'completed'  %}selected{% endif %}>Completed</option>
        <option value="failed"     {% if filters.status == 'failed'     %}selected{% endif %}>Failed</option>
      </select>
    </label>
    <div style="display:flex;align-items:flex-end;gap:8px;">
      <button type="submit" class="btn-primary btn-sm">Filter</button>
      <a href="{{ url_for('admin_dashboard.transactions') }}" class="btn-secondary btn-sm">Clear</a>
    </div>
  </div>
</form>

<div class="card" style="padding:0;overflow:hidden;">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Provider</th>
          <th>Amount</th>
          <th>Currency</th>
          <th>Status</th>
          <th>Customer</th>
          <th>Created</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for tx in items %}
        <tr onclick="window.location='{{ url_for('admin_dashboard.transaction_detail', transaction_id=tx.id) }}'">
          <td class="mono" style="color:var(--muted);font-size:11px;">{{ tx.id[:8] }}…</td>
          <td><span class="badge badge-neutral">{{ (tx.provider or '—') | upper }}</span></td>
          <td class="mono">{{ "%.2f"|format(tx.amount or 0) }}</td>
          <td class="mono">{{ tx.currency or '—' }}</td>
          <td>
            {% set s = tx.status %}
            <span class="badge
              {% if s == 'completed' %}badge-success
              {% elif s == 'failed'  %}badge-danger
              {% elif s == 'pending' %}badge-warning
              {% else %}badge-neutral{% endif %}">
              {{ s or '—' }}
            </span>
          </td>
          <td style="font-size:12px;">{{ tx.get('customer', {}).get('name', '—') }}</td>
          <td class="mono text-muted" style="font-size:11px;">{{ (tx.created_at or '—')[:19] }}</td>
          <td>
            <a href="{{ url_for('admin_dashboard.transaction_detail', transaction_id=tx.id) }}"
               class="btn-secondary btn-sm" onclick="event.stopPropagation();">View</a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" style="text-align:center;color:var(--muted);padding:32px;font-size:13px;">
            No transactions found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% if pagination %}
<div class="pagination">
  <span class="text-muted mono" style="font-size:11px;margin-right:8px;">
    {{ pagination.get('total', 0) }} total
  </span>
  {% if pagination.get('has_prev') %}
    <a href="?page={{ pagination.page - 1 }}&provider={{ filters.provider }}&status={{ filters.status }}" class="page-btn">‹</a>
  {% endif %}
  {% for p in range(1, pagination.get('pages', 1) + 1) %}
    {% if p == pagination.get('page') %}
      <span class="page-btn active">{{ p }}</span>
    {% elif p <= 3 or p > pagination.pages - 3 or (p >= pagination.page - 1 and p <= pagination.page + 1) %}
      <a href="?page={{ p }}&provider={{ filters.provider }}&status={{ filters.status }}" class="page-btn">{{ p }}</a>
    {% elif p == 4 or p == pagination.pages - 3 %}
      <span class="page-btn" style="cursor:default;border:none;">…</span>
    {% endif %}
  {% endfor %}
  {% if pagination.get('has_next') %}
    <a href="?page={{ pagination.page + 1 }}&provider={{ filters.provider }}&status={{ filters.status }}" class="page-btn">›</a>
  {% endif %}
</div>
{% endif %}

{% endblock %}