{% extends "base.html" %}

{% block title %}Audit Logs — PayGateway Admin{% endblock %}
{% block topbar_title %}Audit Logs{% endblock %}

{% block content %}

<!-- Filters -->
<form method="GET" action="{{ url_for('admin_dashboard.audit_logs') }}">
  <div class="filter-bar">
    <label>
      Transaction ID
      <input type="text" name="transaction_id" class="input-field"
             placeholder="UUID…" value="{{ filters.transaction_id }}" />
    </label>
    <label>
      Event Type
      <input type="text" name="event_type" class="input-field"
             placeholder="payment.completed" value="{{ filters.event_type }}" />
    </label>
    <label>
      User ID
      <input type="text" name="user_id" class="input-field"
             placeholder="User…" value="{{ filters.user_id }}" />
    </label>
    <label>
      Start Date
      <input type="date" name="start_date" class="input-field" value="{{ filters.start_date }}" />
    </label>
    <label>
      End Date
      <input type="date" name="end_date" class="input-field" value="{{ filters.end_date }}" />
    </label>
    <div style="display:flex;align-items:flex-end;gap:8px;">
      <button type="submit" class="btn-primary btn-sm">Filter</button>
      <a href="{{ url_for('admin_dashboard.audit_logs') }}" class="btn-secondary btn-sm">Clear</a>
    </div>
  </div>
</form>

<div class="card" style="padding:0;overflow:hidden;">
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Event Type</th>
          <th>Transaction ID</th>
          <th>User</th>
          <th>IP Address</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody>
        {% for log in result.get('items', []) %}
        <tr>
          <td class="mono text-muted" style="font-size:11px;white-space:nowrap;">{{ (log.get('created_at', '—'))[:19] }}</td>
          <td>
            <span class="mono" style="font-size:12px;color:var(--blue);">{{ log.get('event_type', '—') }}</span>
          </td>
          <td class="mono text-muted" style="font-size:11px;">
            {% if log.get('transaction_id') %}
              <a href="{{ url_for('admin_dashboard.transaction_detail', transaction_id=log.transaction_id) }}"
                 style="color:var(--blue);text-decoration:none;">{{ log.transaction_id[:8] }}…</a>
            {% else %}—{% endif %}
          </td>
          <td style="font-size:12px;">{{ log.get('user_id', '—') }}</td>
          <td class="mono" style="font-size:11px;color:var(--muted);">{{ log.get('ip_address', '—') }}</td>
          <td style="font-size:12px;color:var(--muted);max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            {{ log.get('details', '') or '—' }}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" style="text-align:center;color:var(--muted);padding:32px;font-size:13px;">No audit logs found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
{% set pagination = result.get('pagination', {}) %}
{% if pagination %}
<div class="pagination">
  <span class="text-muted mono" style="font-size:11px;margin-right:8px;">{{ pagination.get('total', 0) }} total</span>
  {% if pagination.get('has_prev') %}
    <a href="?page={{ pagination.page - 1 }}&transaction_id={{ filters.transaction_id }}&event_type={{ filters.event_type }}&user_id={{ filters.user_id }}&start_date={{ filters.start_date }}&end_date={{ filters.end_date }}" class="page-btn">‹</a>
  {% endif %}
  {% for p in range(1, pagination.get('pages', 1) + 1) %}
    {% if p == pagination.get('page') %}
      <span class="page-btn active">{{ p }}</span>
    {% elif p <= 2 or p > pagination.pages - 2 or (p >= pagination.page - 1 and p <= pagination.page + 1) %}
      <a href="?page={{ p }}&transaction_id={{ filters.transaction_id }}&event_type={{ filters.event_type }}&user_id={{ filters.user_id }}&start_date={{ filters.start_date }}&end_date={{ filters.end_date }}" class="page-btn">{{ p }}</a>
    {% endif %}
  {% endfor %}
  {% if pagination.get('has_next') %}
    <a href="?page={{ pagination.page + 1 }}&transaction_id={{ filters.transaction_id }}&event_type={{ filters.event_type }}&user_id={{ filters.user_id }}&start_date={{ filters.start_date }}&end_date={{ filters.end_date }}" class="page-btn">›</a>
  {% endif %}
</div>
{% endif %}

{% endblock %}