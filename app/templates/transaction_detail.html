{% extends "base.html" %}

{% block title %}Transaction {{ transaction.get('id', '')[:8] }} — PayGateway Admin{% endblock %}
{% block topbar_title %}Transaction Detail{% endblock %}

{% block topbar_actions %}
  <a href="{{ url_for('admin_dashboard.transactions') }}" class="btn-secondary btn-sm">← Back</a>
  <form method="POST" action="{{ url_for('admin_dashboard.verify_payment', transaction_id=transaction.get('id', '')) }}" style="margin:0;">
    <button type="submit" class="btn-primary btn-sm">
      <svg width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Verify with Provider
    </button>
  </form>
{% endblock %}

{% block content %}
{% set tx = transaction %}
{% set s  = tx.get('status', '') %}

<div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;">

  <!-- Main info -->
  <div style="display:flex;flex-direction:column;gap:20px;">

    <!-- Header card -->
    <div class="card">
      <div class="flex items-center gap-3 mb-2">
        <span class="badge
          {% if s == 'completed' %}badge-success
          {% elif s == 'failed'  %}badge-danger
          {% elif s == 'pending' %}badge-warning
          {% else %}badge-neutral{% endif %}"
          style="font-size:13px;padding:5px 14px;">{{ s | upper }}</span>
        <span class="mono text-muted" style="font-size:12px;">{{ tx.get('id', '—') }}</span>
      </div>
      <div style="font-family:'Syne',sans-serif;font-size:32px;font-weight:800;" class="gradient-text">
        {{ "%.2f"|format(tx.get('amount', 0)) }} {{ tx.get('currency', '') }}
      </div>
      <div class="text-muted mono" style="font-size:12px;margin-top:6px;">
        {{ (tx.get('created_at', '—'))[:19] }}
      </div>
    </div>

    <!-- Details -->
    <div class="card">
      <div class="section-title">Transaction Details</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;">
        {% set fields = [
          ('Provider',        tx.get('provider', '—') | upper),
          ('Reference',       tx.get('provider_reference', '—')),
          ('Idempotency Key', tx.get('idempotency_key', '—')),
          ('Updated At',      (tx.get('updated_at', '—'))[:19]),
        ] %}
        {% for label, value in fields %}
        <div style="padding:14px 16px;border-bottom:1px solid var(--border);{% if loop.index is odd %}border-right:1px solid var(--border);{% endif %}">
          <div style="font-size:10px;font-family:'Space Mono',monospace;letter-spacing:.07em;color:var(--muted);text-transform:uppercase;margin-bottom:4px;">{{ label }}</div>
          <div style="font-size:13px;font-family:'Space Mono',monospace;word-break:break-all;">{{ value }}</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Metadata -->
    {% if tx.get('metadata') %}
    <div class="card">
      <div class="section-title">Metadata</div>
      <pre style="font-family:'Space Mono',monospace;font-size:12px;color:var(--muted);white-space:pre-wrap;word-break:break-all;background:rgba(0,0,0,.2);padding:16px;border-radius:10px;border:1px solid var(--border);">{{ tx.metadata | tojson(indent=2) }}</pre>
    </div>
    {% endif %}

  </div>

  <!-- Sidebar info -->
  <div style="display:flex;flex-direction:column;gap:20px;">

    <!-- Customer -->
    <div class="card">
      <div class="section-title">Customer</div>
      {% set cust = tx.get('customer', {}) %}
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div>
          <div class="text-muted" style="font-size:10px;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px;">Name</div>
          <div style="font-size:13px;">{{ cust.get('name', '—') }}</div>
        </div>
        <div>
          <div class="text-muted" style="font-size:10px;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px;">Email</div>
          <div style="font-size:13px;">{{ cust.get('email', '—') }}</div>
        </div>
        <div>
          <div class="text-muted" style="font-size:10px;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px;">Phone</div>
          <div style="font-size:13px;font-family:'Space Mono',monospace;">{{ cust.get('phone', '—') }}</div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <div class="section-title">Actions</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <a href="{{ url_for('admin_dashboard.audit_logs') }}?transaction_id={{ tx.get('id', '') }}"
           class="btn-secondary btn-sm" style="justify-content:center;">
           View Audit Trail
        </a>
      </div>
    </div>

  </div>
</div>

{% endblock %}